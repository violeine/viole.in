---
import Layout from "@/layouts/Layout.astro";
import { datascriptQuery, q } from "@/lib/log";
import { stringRules } from "@/lib/logseq/rules";
import { render } from "@viole.in/md";
import Logseq from "@/lib/logseq/Logseq.astro";

const t = await render(`## TIL`, true);

const model = `[
    :db/id
    :block/content
    :block/properties
    {:block/page [:db/id :block/name :block/journal-day]}
    {:block/_parent ...}]`;

const pl = [
  `
  [
    :find (pull ?b ${model})
    :in $ % 
    :where (property ?b :til _)
  ]
`,
  `[${stringRules}]`,
];
const result = await datascriptQuery(pl).then((e) =>
  e
    .flat(Infinity)
    .toSorted((a, b) => b["page"]["journal-day"] - a["page"]["journal-day"]),
);
---

<Layout>
  <div set:html={t} />
  {
    result.map((el) => (
      <ul>
        <li>
          <p>
            <span>{el["page"]["name"]}</span>: <span>{el.properties.til}</span>
          </p>
          {el._parent ? <Logseq _parent={el._parent} /> : null}
        </li>
      </ul>
    ))
  }
</Layout>
